<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Recibo de Salida</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    *{margin:0;padding:0;box-sizing:border-box}

    /* Ticket 80mm */
    body{
      width:80mm;
      padding:8px 10px;
      font-family:"Arial Narrow","Roboto Condensed","Helvetica Neue",Arial,sans-serif;
      font-size:14px;color:#000
    }

    .empresa{font-weight:800;font-size:18px;text-transform:uppercase}
    .sub{font-size:13px;margin-top:2px}
    .linea{border:none;border-top:1px dashed #000;margin:8px 0}

    .etq{font-weight:700}
    .placa{font-weight:800;font-size:18px;margin:6px 0}

    /* Bloque FACTURA: izq texto; der contenedor vertical con TRACK ID arriba y QR abajo */
    .factura-bloque{
      display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin:8px 0
    }
    .factura-izq{
      flex:1;min-width:0;text-align:left;font-size:13px;line-height:1.25
    }
    .factura-der{
      display:flex;flex-direction:column;align-items:center;gap:6px
    }
    .trackid{
      font-weight:800;font-size:14px;text-align:center;word-break:break-all;max-width:110px
    }
    .factura-qr{width:96px;height:96px}

    /* TOTAL grande */
    .total-label{font-size:13px;font-weight:800;text-align:center;margin-top:6px}
    .total-valor{
      font-family:"Archivo Black",Impact,"Anton",sans-serif;
      font-size:38px;line-height:1.05;text-align:center;font-weight:900;margin-top:2px
    }

    .poliza{font-size:12px;margin-top:4px;text-align:center}
    .mensaje-inferior{font-size:12px;text-align:center;margin-top:8px}

    /* N° Recibo cuando no hay factura */
    .nrecibo{font-weight:700;font-size:14px;text-align:right;margin:6px 0}

    @media print{body{margin:0}}
  </style>
</head>
<body>
  <!-- Encabezado -->
  <div class="empresa" id="empresa"></div>
  <div class="sub"><span class="etq">NIT:</span> <span id="nit"></span></div>
  <div class="sub" id="direccion"></div>
  <div class="sub"><span class="etq">HORARIO:</span> <span id="horario"></span></div>
  <hr class="linea" />

  <!-- Datos servicio -->
  <div class="placa">PLACA: <span id="placa"></span></div>
  <div class="sub"><span class="etq">ENTRADA:</span> <span id="fentrada"></span></div>
  <div class="sub"><span class="etq">SALIDA:</span> <span id="fsalida"></span></div>
  <div class="sub"><span class="etq">DURACIÓN:</span> <span id="duracion"></span></div>
  <div class="poliza" id="poliza"></div>
  <hr class="linea" />

  <!-- FACTELEC: texto izq / track+QR der -->
  <div id="bloqueFactura" class="factura-bloque" style="display:none;">
    <div class="factura-izq">
      <div id="msgFactura"></div>
    </div>
    <div class="factura-der">
      <div id="lblTrack" class="trackid"></div>
      <div id="qrcode" class="factura-qr"></div>
    </div>
  </div>

  <!-- Cuando NO hay factura -->
  <div id="nrecibo" class="nrecibo" style="display:none;">N.° RECIBO: <span id="nreciboVal"></span></div>

  <hr class="linea" />
  <!-- TOTAL -->
  <div class="total-label">TOTAL A PAGAR</div>
  <div class="total-valor">$<span id="total"></span></div>

  <!-- Mensaje inferior -->
  <div id="msgSalida" class="mensaje-inferior"></div>

  <!-- QR library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script>
    function qp(k){return new URLSearchParams(window.location.search).get(k)||""}
    function fmtCOP(n){
      const v=Number(String(n).replace(/[^0-9.-]/g,""));
      return isNaN(v)?String(n):v.toLocaleString("es-CO");
    }
    function setText(id,val){const el=document.getElementById(id);if(el) el.textContent=val||""}

    function init(){
      // Encabezado
      setText("empresa", qp("Empresa") || qp("TituloRecibo") || "");
      setText("nit", qp("DatosNit"));
      setText("direccion", qp("DatosDireccion"));
      setText("horario", qp("DatosHorario"));
      setText("poliza", qp("DatosPoliza"));

      // Servicio
      setText("placa", qp("Placa"));
      setText("fentrada", qp("EntradaFecha"));
      setText("fsalida", qp("SalidaFecha"));
      setText("duracion", qp("SalidaDuracion"));

      // Total
      setText("total", fmtCOP(qp("SalidaValor")));

      // Mensaje inferior
      setText("msgSalida", qp("MensajeSalida"));

      // Lógica factura/recibo
      const esFactura = qp("EsFactura")==="1";
      const bloqueFactura = document.getElementById("bloqueFactura");
      const nreciboBox = document.getElementById("nrecibo");

      if(esFactura){
        // Mensaje de instrucciones a la izquierda
        const msg = qp("MensajeLegal");
        document.getElementById("msgFactura").textContent = msg || "";

        // TRACK ID arriba del QR (derecha)
        const tid = qp("TrackID");
        setText("lblTrack", tid ? ("TRACK ID: "+tid) : "");
        if(tid){
          new QRCode(document.getElementById("qrcode"),{
            text:tid,width:96,height:96,colorDark:"#000000",colorLight:"#ffffff",
            correctLevel: QRCode.CorrectLevel.H
          });
        }
        bloqueFactura.style.display="flex";
      }else{
        // Recibo simple
        const nro = qp("NRecibo") || qp("TrackID");
        if(nro){ setText("nreciboVal", nro); nreciboBox.style.display="block"; }
      }

      // Auto print
      setTimeout(()=>{ window.print(); setTimeout(()=>window.close(), 600); }, 300);
    }
    window.onload=init;
  </script>
</body>
</html>
