<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Recibo de Parqueadero - Aparko</title>

  <!-- Barcode -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <!-- QR -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    @media print { body { width: 80mm; } }

    body {
      width: 80mm;
      margin: 0 auto;
      font-family: Arial, sans-serif;
      padding: 10px;
      font-size: 13px;
    }
    h1 { margin: 0 0 8px 0; font-size: 16px; font-weight: bold; text-align:left; }
    p { margin: 2px 0; }
    .info { margin-bottom: 6px; }
    .separador { border-top: 1px solid #000; margin: 8px 0; }
    .placa-label { margin-top: 4px; font-weight: bold; }
    .placa-grande { font-size: 28px; font-weight: bold; text-align: center; margin-top: 6px; }
    .barcode { text-align: center; margin-top: 4px; margin-bottom: 8px; }
    .titulo-bloque { font-weight: bold; margin-top: 8px; margin-bottom: 4px; }
    .qr-container { display: flex; flex-direction: column; align-items: center; margin-top: 10px; }
    .qr-box { margin: 8px 0; }
    .qr-text { font-size: 12px; text-align: right; width: 100%; }
    .mensaje { font-size: 11px; text-align: center; margin-top: 6px; }
    .muted { font-size: 11px; line-height: 1.2; }
    .small { font-size: 11px; }
  </style>

  <script>
    function getParams() {
      const params = {};
      location.search.slice(1).split("&").forEach(p => {
        if (!p) return;
        const [k, v] = p.split("=");
        params[decodeURIComponent(k)] = decodeURIComponent((v || "").replace(/\+/g, " "));
      });
      return params;
    }

    function hasValue(x) {
      if (x === undefined || x === null) return false;
      const v = String(x).trim().toLowerCase();
      return v !== "" && v !== "null" && v !== "undefined" && v !== "na";
    }

    function textOrDefault(elId, v, def="") {
      document.getElementById(elId).textContent = hasValue(v) ? v : def;
    }

    function fillData() {
      const p = getParams();

      // Encabezado
      textOrDefault("empresa", p["Ve.Name"], "APARKO");
      textOrDefault("nit", p.DatosNit, "");
      textOrDefault("direccion", p.DatosDireccion, "");
      textOrDefault("horario", p.DatosHorario, "");

      // Datos principales
      textOrDefault("fecha", p.fecha, "");
      textOrDefault("categoria", p.TipoPlaca, "");
      textOrDefault("placa", p.EntradaPlaca, "");

      // Reglamentación / póliza
      textOrDefault("reglamento", p.VirtualReglamento,
        "El parqueadero no responde por objetos de valor dejados dentro del vehículo. Guarde este tiquete.");
      textOrDefault("poliza", p.DatosPoliza, "");

      // Código de barras
      JsBarcode("#barcode", hasValue(p.EntradaPlaca) ? p.EntradaPlaca : "-", {
        format: "CODE128",
        displayValue: true,
        fontSize: 12,
        height: 40,
        margin: 0
      });

      // QR al final
      const qrSection = document.getElementById("qr-section");
      if (hasValue(p["Vs.LinkUser"])) {
        qrSection.style.display = "block";
        new QRCode(document.getElementById("qrcode"), {
          text: p["Vs.LinkUser"],
          width: 120,
          height: 120,
          correctLevel: QRCode.CorrectLevel.M
        });
      } else {
        qrSection.style.display = "none";
      }
    }

    window.onload = function () {
      fillData();
      setTimeout(() => {
        window.print();
        setTimeout(() => window.close(), 800);
      }, 700);
    };
  </script>
</head>
<body>
  <!-- Encabezado -->
  <h1 id="empresa"></h1>
  <p class="info"><strong>NIT:</strong> <span id="nit"></span></p>
  <p class="info" id="direccion"></p>
  <p class="info"><strong>HORARIO:</strong> <span id="horario"></span></p>

  <div class="separador"></div>

  <!-- Datos principales -->
  <p><strong>ENTRADA:</strong> <span id="fecha"></span></p>
  <p><strong>TARIFA:</strong> <span id="categoria"></span></p>

  <p class="placa-label">PLACA</p>
  <div class="placa-grande" id="placa"></div>

  <div class="barcode">
    <svg id="barcode"></svg>
  </div>

  <div class="separador"></div>

  <!-- Reglamento -->
  <p class="titulo-bloque">REGLAMENTO:</p>
  <p id="reglamento" class="muted"></p>

  <div class="separador"></div>

  <p class="small"><strong>PÓLIZA:</strong> <span id="poliza"></span></p>

  <!-- QR al final -->
<div id="qr-section" style="display:none;">
  <div class="separador"></div>
  
  <!-- Textos alineados a la derecha -->
  <div style="text-align: right; width: 100%;">
    <p><strong>QR GENERA PARA:</strong></p>
    <p>1. Inscripción Factura Electrónica</p>
    <p>2. Conoce nuestras condiciones de prestación del servicio.</p>
  </div>
  
  <!-- QR centrado -->
  <div class="qr-box" id="qrcode" style="text-align: center; margin: 10px 0;"></div>
  
  <!-- Mensaje centrado -->
  <p class="mensaje">Si no registra previamente su placa antes de pagar, la factura no saldrá a su nombre.</p>
</div>
  </div>
</body>
</html>
