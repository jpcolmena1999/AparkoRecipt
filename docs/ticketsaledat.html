<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Recibo de Salida - Aparko</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" defer></script>

<style>
:root{
  --SCALE: 3.0;
  --BASE_TICKET_WIDTH: 58mm;
}

html,body{
  margin:0 !important;
  padding:0 !important;
  background:#fff !important;
  font-family: Arial, sans-serif;
  -webkit-print-color-adjust: exact;
  print-color-adjust: exact;
}

@media print{
  @page{ size:A4; margin:0 !important; }

  body{
    width:210mm !important;
    height:297mm !important;
    margin:0 !important;
    padding:0 !important;
    overflow:hidden !important;
  }

  .ticket{
    width:var(--BASE_TICKET_WIDTH);
    transform:scale(var(--SCALE));
    transform-origin:top left;
  }

  *{ box-sizing:border-box; max-width:100% !important; }
  img,svg,canvas{ max-width:100% !important; height:auto !important; }
}

.ticket{
  width:var(--BASE_TICKET_WIDTH);
  padding:8px;
  font-size:12px;
}

h1{ margin:0 0 4px 0; font-size:15px; font-weight:bold; }
p{ margin:2px 0; }

.sep{ border-top:1px solid #000; margin:6px 0; }

.placa{
  font-size:22px;
  font-weight:bold;
  margin:4px 0;
}

.track{
  font-size:24px;
  font-weight:bold;
  text-align:center;
  margin:6px 0;
}

.msg{
  font-size:12px;
  text-align:center;
  line-height:1.3;
  margin:8px 0;
}

.qr-big{
  width:100%;
  display:flex;
  justify-content:center;
  margin:6px 0;
}

.qr-big canvas{
  width:100% !important;
  height:auto !important;
}

.total-label{
  text-align:center;
  font-weight:bold;
  font-size:12px;
  margin-top:6px;
}

.total{
  text-align:center;
  font-size:28px;
  font-weight:900;
  margin-top:2px;
}

.footer{
  text-align:center;
  font-size:11px;
  margin-top:8px;
}
</style>
</head>

<body>

<div class="ticket">

<h1 id="empresa">APARKO</h1>
<p><strong>NIT:</strong> <span id="nit"></span></p>
<p id="direccion"></p>
<p><strong>HORARIO:</strong> <span id="horario"></span></p>
<p id="poliza"></p>

<div class="sep"></div>

<p><strong>PLACA:</strong></p>
<div class="placa" id="placa"></div>

<p><strong>TARIFA:</strong> <span id="tipo"></span></p>
<p><strong>ENTRADA:</strong> <span id="fentrada"></span></p>
<p><strong>SALIDA:</strong> <span id="fsalida"></span></p>
<p><strong>DURACIÃ“N:</strong> <span id="duracion"></span></p>

<div class="sep"></div>

<div class="track" id="trackid"></div>

<div class="msg" id="msgFactura"></div>

<div class="qr-big">
  <div id="qrcode"></div>
</div>

<div class="total-label">TOTAL A PAGAR</div>
<div class="total">$<span id="total"></span></div>

<div class="footer" id="msgSalida"></div>

<div class="sep"></div>

</div>

<script>
function qp(k){ return new URLSearchParams(location.search).get(k) || ""; }

function fmtCOP(n){
  const v = Number(String(n).replace(/[^0-9.-]/g,""));
  return isNaN(v) ? String(n) : v.toLocaleString("es-CO");
}

function setText(id,val){
  const el=document.getElementById(id);
  if(el) el.textContent=val||"";
}

function makeQR(text){
  const box=document.getElementById("qrcode");
  box.innerHTML="";
  new QRCode(box,{
    text:text||"",
    width:260,
    height:260,
    correctLevel:QRCode.CorrectLevel.M
  });
}

function init(){

  setText("empresa", qp("Empresa") || "APARKO");
  setText("nit", qp("DatosNit"));
  setText("direccion", qp("DatosDireccion"));
  setText("horario", qp("DatosHorario"));
  setText("poliza", qp("DatosPoliza"));

  setText("placa", qp("Placa"));
  setText("tipo", qp("TipoPlaca"));
  setText("fentrada", qp("EntradaFecha"));
  setText("fsalida", qp("SalidaFecha"));
  setText("duracion", qp("SalidaDuracion"));

  setText("total", fmtCOP(qp("SalidaValor")));
  setText("msgSalida", qp("MensajeSalida"));

  const track = qp("TrackID") || qp("NRecibo") || "";
  setText("trackid","Track ID: "+track);

  const msgLegal = qp("MensajeLegal");
  setText("msgFactura", msgLegal);

  const webFac = qp("Vs.WebFac");
  makeQR(webFac || track);

  setTimeout(()=>{
    try{window.print();}catch(e){}
    setTimeout(()=>{try{window.close();}catch(e){}},600);
  },400);
}

if(document.readyState==="complete") init();
else window.addEventListener("load",init);
</script>

</body>
</html>
